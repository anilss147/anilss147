name: üîÅ Auto Update GitHub README

on:
  schedule:
    - cron: "0 0 1 * *"  # Runs on the 1st day of each month at midnight
  workflow_dispatch:

jobs:
  update-readme:
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Repo
        uses: actions/checkout@v3

      - name: üõ†Ô∏è Update README
        run: |
          STATS_URL='![Anil'\''s GitHub stats](https://github-readme-stats.vercel.app/api?username=anilss147&show_icons=true&theme=tokyonight)
![Top Langs](https://github-readme-stats.vercel.app/api/top-langs/?username=anilss147&layout=compact&theme=tokyonight)'

          GRAPH_URL='![GitHub Contribution Graph](https://github-profile-summary-cards.vercel.app/api/cards/profile-details?username=anilss147&theme=github)'

          perl -0777 -i -pe "s/<!-- STATS START -->.*?<!-- STATS END -->/<!-- STATS START -->\n$STATS_URL\n<!-- STATS END -->/s" README.md
          perl -0777 -i -pe "s/<!-- GRAPH START -->.*?<!-- GRAPH END -->/<!-- GRAPH START -->\n$GRAPH_URL\n<!-- GRAPH END -->/s" README.md

          PROJECTS=$(curl -s "https://api.github.com/users/anilss147/repos?per_page=100" | jq -r '.[] | "üîπ [\(.name)](\(.html_url)) - \(.description // \"No description.\")"')
          echo "<!-- PROJECTS START -->" > temp_projects.txt
          echo "$PROJECTS" >> temp_projects.txt
          echo "<!-- PROJECTS END -->" >> temp_projects.txt
          perl -0777 -i -pe "s/<!-- PROJECTS START -->.*?<!-- PROJECTS END -->/`cat temp_projects.txt | sed 's/\\/\\\\/g; s/\//\\\//g'`/s" README.md
          rm temp_projects.txt

          FOLLOWERS=$(curl -s "https://api.github.com/users/anilss147/followers?per_page=10" | jq -r '.[] | "- [\(.login)](\(.html_url))"')
          FOLLOWERS_BLOCK="<!-- FOLLOWERS START -->\n$FOLLOWERS\n<!-- FOLLOWERS END -->"
          perl -0777 -i -pe "s/<!-- FOLLOWERS START -->.*?<!-- FOLLOWERS END -->/$FOLLOWERS_BLOCK/s" README.md

      - name: üì§ Commit & Push Changes
        run: |
          git config --global user.name 'github-actions'
          git config --global user.email 'github-actions@github.com'
          git add README.md
          git commit -m "üìà auto: updated GitHub stats, projects, followers" || echo "No changes to commit"
          git push
